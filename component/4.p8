pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- 4 - component hot swapping

function _init()
	entities = {}
	spawn_things()
end

function spawn_things()
	for x=0,15 do
		for y=0,15 do
			if mget(x,y) == 1 then
				-- spawn a bjorn
				local b = _bjorn:new({
					x=x*8,y=y*8,
					-- wire up component here
					input_ = _playerinputcomp
				})
				add(entities,b)
				mset(x,y,0)
			end
		end
	end
end

function _update60()
	cls(0)
	update_mouse()
	for e in all(entities) do
		e:update()
	end
end

function _draw()
	map()
	for e in all(entities) do
		e:draw()
	end
	draw_mouse()
end
-->8
-- components

_playerinputcomp = {
	accel = 0.03
}

function _playerinputcomp:update(a)
	local xinp = 0
	if (btn(➡️)) xinp += 1
	if (btn(⬅️)) xinp -= 1
	
	a.vx += xinp * self.accel
end

_physicscomp = {
	friction = 0.98, -- friction
	gravity = 0.1,  -- gravity
	radius = 4,    -- radius (collision)
}

function _physicscomp:update(a)
	a.vy += self.gravity
	
	if self:map_collision(a,0,a.vy) then
		local d = 0
		while not self:map_collision(a,0,d) do
			d += 0.25 * sgn(a.vy)
		end
		d -= 0.25 * sgn(a.vy)
		
		a.y = a.y + d
		a.vy = 0
	end
	
	if self:map_collision(a,a.vx,0) then
		local d = 0
		while not self:map_collision(a,d,0) do
			d += 0.25 * sgn(a.vx)
		end
		d -= 0.25 * sgn(a.vx)
		
		a.x = a.x + d
		a.vx = 0
	end
	
	a.vx *= self.friction
	a.vy *= self.friction
	
	a.x += a.vx
	a.y += a.vy
end

function _physicscomp:map_collision(a,ox,oy)
	x = ox or 0
	y = oy or 0
	
	x = x+a.x-4
	y = y+a.y-4

	if (x<0) return true
	if (x+7>1024) return true
	if (y<0) return true
	if (y+7>512) return true
	nw = mget((x)/8, (y)/8)
	ne = mget((x+7)/8, (y)/8)
	sw = mget((x)/8, (y+7)/8)
	se = mget((x+7)/8, (y+7)/8)
	return fget(nw, 0) == true
				 or fget(ne, 0) == true
				 or fget(sw, 0) == true
				 or fget(se, 0) == true
end

function _physicscomp:collides(a,b,dx,dy)
	local x = dx or 0
	local y = dy or 0
	x = a.x + x
	y = a.y + y
	local dist2 = 
		(b.x - x)^2 + (b.y - y)^2
	return dist2 < (a.r+b.r)^2
end

_graphicscomp = {
	sprite = 1
}

function _graphicscomp:draw(a)
	local flipx = false
	local s = self.sprite
	
	if (sgn(a.vx) == -1) flipx = true
	
	if abs(a.vx) > .1 then
		s = s + 12*t()%2
	end
	
	spr(s,a.x-4,a.y-4,1,1,flipx)
end
-->8
-- the bjorn class

_bjorn = {
	x = 64, -- position
	y = 24,
	vx = 0, -- velocity
	vy = 0,
	id = 0,   -- identifier
	
	input_ = nil, -- input component
	physics_ = _physicscomp, -- physics component
	graphics_ = _graphicscomp -- graphics component
}

function _bjorn:new(o)
 --[[
 	this is just how you set up
 	class stuff in lua
 ]]-- 
	o = o or {}
	setmetatable(o, self)
	self.__index = self
	o.id = self.id
	self.id += 1
	return o
end

--------------------------------

function _bjorn:update()
	self.input_:update(self)
	self.physics_:update(self)
end

function _bjorn:draw()
	self.graphics_:draw(self)
end

--------------------------------

-->8
-- mouse

poke(0x5f2d, 1)

function update_mouse()
	_mx = stat(32)
	_my = stat(33)
	_mb = stat(34)
	_mb1_pf = _mb1 or false
	_mb2_pf = _mb2 or false
	_mb1 = band(_mb, 1) != 0
	_mb2 = band(_mb, 2) != 0
	_mmb = band(_mb, 4) != 0
	_mb1_p = _mb1 and not _mb1_pf
	_mb2_p = _mb2 and not _mb2_pf
end

function draw_mouse()
	spr(0,_mx-4, _my-4)
end
__gfx__
00000000000000000676767000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000067676700676767000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000067676700777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000077777700aa1aa1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000880000aa1aa100aaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa00055550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555000400004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
