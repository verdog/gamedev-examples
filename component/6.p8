pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- 6 - generalized

function _init()
	entities = {}
	spawn_things()
	
	_gamestate = "title"
end

function spawn_things()
	for x=0,15 do
		for y=0,15 do
			if mget(x,y) == 1 then
				-- spawn a bjorn
				local b = _actor:new({
					x=x*8,y=y*8,
					-- wire up components here
					input_ = _demoinputcomp,
					physics_ = _bjornphysicscomp,
					graphics_ = _bjorngraphicscomp,
					name = "bjorn"
				})
				add(entities,b)
				mset(x,y,0)
			end
		end
	end
end

function _update60()
	cls(0)
	update_mouse()
	
	if btnp(❎) and _gamestate == "title" then
		_gamestate = "play"
		for e in all(entities) do
			if e.name != nil and e.name == "bjorn" then
				e.input_ = _playerinputcomp
			end
		end
	end
	
	for e in all(entities) do
		e:update()
	end
end

function _draw()
	map()
	
	if _gamestate == "title" then
		local x = 12 + rnd(2)-1
		local y = 24 + rnd(2)-1
		local x2 = 48 + rnd(2)-1
		local y2 = 80 + rnd(2)-1 
		
		spr(3,x,y,13,4)
		
		print("press ❎", x2, y2, 10)
	end
	
	for e in all(entities) do
		e:draw()
	end
	draw_mouse()
end

-->8
-- components

_playerinputcomp = {
	accel = 0.03
}

function _playerinputcomp:update(a)
	local xinp = 0
	if (btn(➡️)) xinp += 1
	if (btn(⬅️)) xinp -= 1
	
	a.vx += xinp * self.accel
end

_demoinputcomp = {
	accel = 0.03,
	timer = 90,
	direction = 1
}

function _demoinputcomp:update(a)
	self.timer -= 1
	if self.timer == 0 then
		self.direction *= -1
		self.timer = flr(40 + rnd(80))
	end
	
	a.vx += self.accel * self.direction
end

_bjornphysicscomp = {
	friction = 0.98, -- friction
	gravity = 0.1,  -- gravity
	radius = 4,    -- radius (collision)
}

function _bjornphysicscomp:update(a)
	a.vy += self.gravity
	
	if self:map_collision(a,0,a.vy) then
		local d = 0
		while not self:map_collision(a,0,d) do
			d += 0.25 * sgn(a.vy)
		end
		d -= 0.25 * sgn(a.vy)
		
		a.y = a.y + d
		a.vy = 0
	end
	
	if self:map_collision(a,a.vx,0) then
		local d = 0
		while not self:map_collision(a,d,0) do
			d += 0.25 * sgn(a.vx)
		end
		d -= 0.25 * sgn(a.vx)
		
		a.x = a.x + d
		a.vx = 0
	end
	
	a.vx *= self.friction
	a.vy *= self.friction
	
	a.x += a.vx
	a.y += a.vy
end

function _bjornphysicscomp:map_collision(a,ox,oy)
	x = ox or 0
	y = oy or 0
	
	x = x+a.x-4
	y = y+a.y-4

	if (x<0) return true
	if (x+7>1024) return true
	if (y<0) return true
	if (y+7>512) return true
	nw = mget((x)/8, (y)/8)
	ne = mget((x+7)/8, (y)/8)
	sw = mget((x)/8, (y+7)/8)
	se = mget((x+7)/8, (y+7)/8)
	return fget(nw, 0) == true
				 or fget(ne, 0) == true
				 or fget(sw, 0) == true
				 or fget(se, 0) == true
end

function _bjornphysicscomp:collides(a,b,dx,dy)
	local x = dx or 0
	local y = dy or 0
	x = a.x + x
	y = a.y + y
	local dist2 = 
		(b.x - x)^2 + (b.y - y)^2
	return dist2 < (a.r+b.r)^2
end

_bjorngraphicscomp = {
	sprite = 1
}

function _bjorngraphicscomp:draw(a)
	local flipx = false
	local s = self.sprite
	
	if (sgn(a.vx) == -1) flipx = true
	
	if abs(a.vx) > .1 then
		s = s + 12*t()%2
	end
	
	spr(s,a.x-4,a.y-4,1,1,flipx)
	
	local yoff = s >= 2 and -1 or 0
	if not flipx then
		spr(17,a.x-4+6,a.y-4-10+yoff,2,2)
	else
		spr(17,a.x-4-14,a.y-4-10+yoff,2,2,true)
	end
end

-->8
-- the actor class

_actor = {
	x = 64, -- position
	y = 24,
	vx = 0, -- velocity
	vy = 0,
	id = 0,   -- identifier
	
	input_ = nil, -- input component
	physics_ = nil, -- physics component
	graphics_ = nil -- graphics component
}

function _actor:new(o)
 --[[
 	this is just how you set up
 	class stuff in lua
 ]]-- 
	o = o or {}
	setmetatable(o, self)
	self.__index = self
	o.id = self.id
	self.id += 1
	return o
end

--------------------------------

function _actor:update()
	self.input_:update(self)
	self.physics_:update(self)
end

function _actor:draw()
	self.graphics_:draw(self)
end

--------------------------------

-->8
-- mouse

poke(0x5f2d, 1)

function update_mouse()
	_mx = stat(32)
	_my = stat(33)
	_mb = stat(34)
	_mb1_pf = _mb1 or false
	_mb2_pf = _mb2 or false
	_mb1 = band(_mb, 1) != 0
	_mb2 = band(_mb, 2) != 0
	_mmb = band(_mb, 4) != 0
	_mb1_p = _mb1 and not _mb1_pf
	_mb2_p = _mb2 and not _mb2_pf
end

function draw_mouse()
	spr(0,_mx-4, _my-4)
end

__gfx__
00000000000000000676767000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000067676700676767000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000067676700777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000077777700aa1aa1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000880000aa1aa100aaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa0005555000000aa00000000000000000000000000000000000000000000000000000000000000000000000000000aa0000000000000000000
0000000000555500040000400000aaaaaa000000000000000000000000000000000000000000000000000000000000000000000000aaa000aaa0000000000000
0000000000400400000000000000aaaaaaaa00000aa000000000000000000000aa000000000000aaaaaaa000000000000000000000aa00aaaaa0000000000aa0
0000000000000000000000000000aa000aaa00000aa00000000aa0aa000aa000aa00aaaa000000aaaaaaa000000000aa00000aaaaaaa00aaaaaa000aaa000aa0
0000000000000000000000000000aa0000aaa0000aa00000000aaaaa000aaaaaaa00aaaaa00000aaa00aaa00000000aa00000aaaaaaa00aa00aa000aaa000aa0
0000000000000000000676000000aa00000aa0000aa0000000aaaaaa000aaaaaaa00aa0aaa0000aa0000aaa0000000aa0000aaa0aaa00aaa00aaa00aaa000aa0
0000000000000000007676000000aaa0000aa0000aa0000000aa0aaa000aaaaaa000aa00aaa000aa0000aaa0000000aa0000aaa0aaa00aaa000aa000aaa00aa0
00000000000000000776760000000aa0000aa0000aa000000aaa0aaa00aaa0aaa000aa000aaa00aa00000aa0000000aa0000aa00aaa000aa000aa000aaa00aa0
00000000000000006776700000000aa0000aa0000aa000000aa00aaaa0aa00aaa000aa0000aa00aa00000aa0000000aa0000aa00aaaa00aa00aaa000aaa00aa0
00000000000000066776000000000aa000aaa0000aa000000aa00aaaa0aa00aaaa00aa0000aa00aaa000aaa0000000aa000aaa00aaaa00aa00aa0000aaaa0aa0
00000000000000666770000000000aa00aaa00000aa000000aa0aaaaa0aa0aaaaa00aa0000aa000aa000aa00000000aa000aa000aaaa00aa0aaa0000aaaa0aa0
33333333002006666700000000000aa0aaaa00000aa000000aa0aa0aa0aa0aa0aa00aa0000aa000aa00aaa00000000aa000aa000aaaa00aaaaaa0000aaaa0aa0
bbbbbbbb02446666d000000000000aaaaaa000000aa000000aaaaa0aa0aaaaa0aa00aa0000aa000aa0aaa000000000aaa00aa00aaaaa00aaaa000000aaaa0aaa
bbbbbbbb0024466d0000000000000aaaaaaaaa000aa000000aaaaa0aa00aaaa0aa00aa0000aa000aaaaa00000000000aa00aa00aa0aa00aaaaa00000aaaaa0aa
33333333000244d00000000000000aa00aaaaaa00aa0000000aaaa0aa00aaaa0aa00aa0000aa000aaaaaaa000000000aa00aa00aa0aa00aaaaa00000aa0aa0aa
33333333002224400000000000000aa000000aa00aa0000000aaa00aa00aaaa0aa00aa0000aa000aaaaaaaa00000000aa00aa0aaaaaa00aa0aaa0000aa0aa0aa
bbbbbbbb022202420000000000000aa000000aa00aa0000000aaaa0aa000aaa0aa00aa0000aa000aa000aaaa0000000aa00aa0aa0aa000aa00aa0000aa0aaaaa
bbbbbbbb222000200000000000000aaa00000aa00aa00000000aaaaaa00aaaaaaa00aa000aaa000aa00000aaa000000aa00aaaaa0aa000aa00aa0000aa0aaaaa
333333330200000000000000000000aa0000aaa00aaa000000aaaaaa000aaaaaa000aa00aaa0000aa00000aaa000000aa000aaaaaaa000aa00aaa000aa00aaaa
000000000000000000000000000000aa000aaa000aaaaaaa00aa0000000aa0000000aa0aaaa0000aa00000aaa000000aa000aaaaaaa000aa000aa000aa00aaaa
000000000000000000000000000000aa00aaaa0000aaaaaa00aa0000000aa0000000aaaaa000000aa0000aaa00aaa0aaa000aaaaaa000000000aaa00aa000aaa
000000000000000000000000000000aaaaaaa0000000000000aa0000000aa0000000aaaa0000000aa000aaa000aaaaaaa0000aaa000000000000aa00aa0000aa
00000000000000000000000000000aaaaaa000000000000000000000000000000000aa000000000aaaaaaaa0000aaaa000000aa0000000000000aa0000000000
00000000000000000000000000000aaa00000000000000000000000000000000000000000000000aaaaaaa000000000000000aa0000000000000aaa000000000
00000000000000000000000000000aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000aaa000000000
__gff__
0000000909010101010101000000000000000009090101010101010000000000010100010101010101010100000000000000000101010101010101000000000000000001010101010101010000000000000000010101010101010100000000000000000101010101010101000000000000000001010101010101010000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
