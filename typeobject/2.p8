pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- adding constructors

function _init()
	entities = {}
	breeds = init_breeds()
	add(entities, _player:new({
		x=24,y=48
	}))
	gamestate = "appear"
	statet = 0
	text = "blahblah"
end

function rnd_monster()
	local b = breeds[flr(rnd(#breeds))]
	return b:new_monster()
end

function _update()
	cls(0)
	update_mouse()
	
	if gamestate == "appear" then
		-- appear
		if statet == 0 then
			local m = rnd_monster()
			add(entities, m)
			text = "a "..m.breed.name.." appears!"
		elseif statet == 120 then
			gamestate = "pturn"
			statet = -1
		end
	elseif gamestate == "pturn" then
		-- player's turn
		if statet == 0 then
			text = "press ❎ to attack!"
		end
		
		if btnp(❎) then
			gamestate = "eturn"
			statet = -1
		end
	elseif gamestate == "eturn" then
		-- enemy's turn
		if statet == 0 then
			-- get current monster...
			local m = nil
			for e in all(entities) do
				if e.breed != nil then
					m = e
				end
			end
			text =	"you attack the "..m.breed.name.."!\n"
			text = text.."you do "..flr(rnd(4)).." damage!\n"
			text = text..m.breed.attack.."\n"
			text = text.."it does "..m.breed.damage.." damage!" 
		elseif statet == 240 then
			gamestate = "pturn"
			statet = -1
		end
	end
		
	statet += 1
		
	for e in all(entities) do
		e:update()
	end
end

function _draw()
	map()
	for e in all(entities) do
		e:draw()
	end
	
	-- textbox
	local x1 = 8
	local x2 = 128-16
	local y1 = 128-6*8
	local y2 = 128-1*8
	for x=x1+8,x2-8,8 do
		spr(17,x,y1)
		spr(49,x,y2)
	end
	for y=y1+8,y2-8,8 do
		spr(32,x1,y)
		spr(34,x2,y)
	end
	spr(16,x1,y1)
	spr(18,x2,y1)
	spr(48,x1,y2)
	spr(50,x2,y2)
	
	-- text
	print(sub(text,1,statet), x1+4, y1+4)
	
	draw_mouse()
end
-->8
-- the breeds

_breed = {
	health = 0,
	damage = 0,
	sprite = 0,
	name   = "unamed",
	attack = ""
}

function _breed:new(o)
	o = o or {}
	setmetatable(o, self)
	self.__index = self
	return o
end
 
function init_breeds()
	local breeds = {}
	add(breeds,_breed:new({
		health = 5,
		damage = 2,
		sprite = 2,
		name   = "ghost",
		attack = "the ghost is spooky!"
	}))
	
	add(breeds,_breed:new({
		health = 3,
		damage = 3,
		sprite = 3,
		name   = "spider",
		attack = "the spider spits venom!"
	}))
	
	add(breeds,_breed:new({
		health = 6,
		damage = 1,
		sprite = 4,
		name   = "mole",
		attack = "the mole uses earthquake!"
	}))
	
	return breeds
end

function _breed:getattack()
	return self.attack
end

function _breed:new_monster()
	local m = _monster:new()
	m.health = self.health
	m.breed = self
	m.x=128-32
	m.y=48
	return m
end
-->8
-- the monster class

_monster = {
	x = 64, -- position
	y = 24,
	
	health = 0,
	breed = nil
}

function _monster:new(o)
 --[[
 	this is just how you set up
 	class stuff in lua
 ]]-- 
	o = o or {}
	setmetatable(o, self)
	self.__index = self
	return o
end

function _monster:update()
	-- do nothing by default
end

function _monster:draw()
	-- draw breed sprite
	spr(self.breed.sprite, self.x, self.y+4*sin(t()/3))
end

function _monster:getattack()
	return self.breed.attack
end

-->8
-- the player class

_player = {
	x = 0,
	y = 0
}

function _player:new(o)
	o = o or {}
	setmetatable(o, self)
	self.__index = self
	return o
end

function _player:update()

end

function _player:draw()
	spr(1,self.x,self.y+3*cos(t()/3))
end

-->8
-- mouse

poke(0x5f2d, 1)

function update_mouse()
	_mx = stat(32)
	_my = stat(33)
	_mb = stat(34)
	_mb1_pf = _mb1 or false
	_mb2_pf = _mb2 or false
	_mb1 = band(_mb, 1) != 0
	_mb2 = band(_mb, 2) != 0
	_mmb = band(_mb, 4) != 0
	_mb1_p = _mb1 and not _mb1_pf
	_mb2_p = _mb2 and not _mb2_pf
end

function draw_mouse()
	spr(0,_mx-4, _my-4)
end
__gfx__
00000000000000000077770000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000770000777777077000077007007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000770000787787000700700000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000000000000777777077877877080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000077777700777777000777700088777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000770000777777007700770077778700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000770000777777070700707077777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007007000707070000000000077777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000010100000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
